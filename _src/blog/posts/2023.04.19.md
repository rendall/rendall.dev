---
title: 'Git Hooks for WIP Commits'
date: 2023-04-19
layout: layouts/post.njk
description: Use git hooks to remind yourself about stashed changes or commits that are works in progress.
permalink: posts/2023/4/19/problem-git-local-changes-will-be-overwritten-but-you-do-not-want-to-git-stash/index.html
tags:
  - code
  - git
---

Use git hooks to remind yourself about stashed changes or commits that are works in progress.

Problem: In git, you type `git checkout master` (or some branch) and get the following message:

```text
error: Your local changes to the following files would be overwritten by checkout:
        src/app/superhero/capeColors.ts
        src/app/villain/evilLair.ts
        src/app/quest/adventures.json
        src/assets/images/unicorn.png
```

You *could* `git stash` your changes, switch your branch, and then later on switch back and `git stash pop`.

However, what if you do not know *when* you will switch back? It could be in a few minutes, or perhaps next year. You might *forget* that you made those changes and then accidentally *redo* work that you have already done.

On the other hand, the changes aren't really commit-worthy. You don't want them to be part of your commit history. A full `git commit -m "Add QuantumSwarm optimizer"` is not really what you want.

You could add some kind of prefix that means *work in progress* like `WIP:` to your commit, e.g. `git commit -m "WIP: Don't reallly commit this!"` but, again, you do not really know when you will be back to this branch. If you begin work again and accidentally commit after your `WIP:` commit, you will have to mess about with your commit history when and if you notice.

It would be better if you could somehow get a reminder that there is a *work in progress* on that branch.

Solution: Go ahead and add the `WIP:` prefix to your commit message. Add a *git hook* to remind yourself that there is a `WIP:` commit when you checkout the branch. If you want, you can actually prevent more commits to that branch until the `WIP:` is removed.

Git hooks are custom scripts that can be triggered by various Git events, allowing you to automate tasks and enforce custom rules or workflows. The two we will need are the `pre-commit` hook and the `post-checkout` hook.

## post-checkout hook

`post-checkout` runs after a branch has been checked out. We can use this to echo a reminder when you switch back to the branch with the WIP commit.

Create a file named `post-checkout` in the `.git/hooks` directory of your repository and paste the following code:

```bash
#!/bin/sh

WIP_COMMIT=$(git log --grep="^WIP:" --format="%h - %s")

if [ ! -z "$WIP_COMMIT" ]; then
    echo "WARNING: There are WIP commits that need attention:"
    echo "$WIP_COMMIT"
fi
```

Or, if you prefer colors!

```bash
#!/bin/sh

WIP_COMMIT=$(git log --grep="^WIP:" --format="%h - %s")

if [ ! -z "$WIP_COMMIT" ]; then
    # ANSI escape code for bright yellow text
    BRIGHT_YELLOW="\033[93m"
    # ANSI escape code for bright orange text
    BRIGHT_ORANGE="\033[38;5;214m"
    # ANSI escape code to reset text color
    RESET="\033[0m"

    echo -e "${BRIGHT_ORANGE}WARNING:${RESET} There are WIP commits that need attention:"
    echo -e "${BRIGHT_YELLOW}$WIP_COMMIT${RESET}"
fi
```

Make the file executable with `chmod +x .git/hooks/post-checkout`.

This hook will display a warning message whenever you switch to a branch with a commit message that starts with `WIP:`.

## pre-commit hook

The pre-commit hook will run after you type `git commit` but before committing. We'll use this to ensure the last commit is *not* prefixed by `WIP:`. If it is, we will echo an error and prevent the commit.

Create a file named `pre-commit` in the `.git/hooks` directory of your repository and paste the following code:

```bash
#!/bin/sh

# Check if the last commit message starts with `WIP:`
last_commit_message=$(git log -1 --pretty=%B)
if echo "$last_commit_message" | grep -q "^WIP:"; then
    echo "Error: The last commit message has the 'WIP:' prefix. Please remove or amend the commit before proceeding."
    exit 1
fi
```

Make the file executable with `chmod +x .git/hooks/pre-commit`.

This hook will prevent you from committing if the last commit message starts with `WIP:`. When you get this message, you can do:

```
git reset --soft HEAD~1
```

This will un-commit your `WIP:` changes and let you continue your work as if there had been no commit.

## .bashrc check

What happens if you switch to the branch with the `WIP:` commit, shut down your IDE and then restart it.  The `post-checkout` hook only runs when you checkout a branch and not when you restart your IDE. You will not be warned in that case. If you're keen to be warned in that case, you can modify your shell configuration file.

Add the following function to the end of your `.bashrc` (or whatever shell configuration file your shell uses):

```bash
function check_wip_commits() {
    local wip_commits=$(git log --grep="^WIP:" --format="%h - %s" 2>/dev/null)

    if [ ! -z "$wip_commits" ]; then
        local bright_orange="\033[38;5;214m"
        local reset="\033[0m"

        echo -e "${bright_orange}WARNING:${reset} There are WIP commits that need attention:"
        echo -e "${wip_commits}"
    fi
}

check_wip_commits
```

Then you can restart your terminal or type `source ~/.bashrc`

## post-commit redux

If you really, really do not want a `WIP:` commit in your history, you could go ahead and `git stash` your changes. Then you could modify the `post-commit` hook to remind yourself that you have uncommitted changes in your stash.  Modify the `post-checkout` hook like this:

```bash
#!/bin/sh

current_branch=$(git rev-parse --abbrev-ref HEAD)
stash_info=$(git stash list | grep ": On ${current_branch}")

if [ -n "$stash_info" ]; then
  echo -e "\033[0;33mReminder: There's a stash for the current branch ($current_branch):\033[0m"
  echo "$stash_info"
  echo -e "\033[0;33mUse 'git stash apply' or 'git stash drop' as needed.\033[0m"
fi
```

Now, when you switch to any branch with changes in stash, you will get a reminder.

## More information

The git documenation on hooks is pretty good: <https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks>

Let me know if you found this useful!